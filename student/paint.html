<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
	    <title>畫板</title>
		<link rel="stylesheet" type="text/css" href="./css/PaintPage.css"/>
	</head>

	<body>
		<div class="box_head">
			<a class="box_head_location" href="index.html"><button class="box_head_back">返回</button></a>
			<h1 class="box_head_title">畫板</h1>
		</div>

		<div id="popWindow" class="popWindow"></div>
		<div id="maskLayer" class="maskLayer">
			<ul>
				<h1>操作提示</h1>
				<li>點：點擊“點”功能按鈕，可繪製一個點</li>
				<li>綫段：點擊“綫段”功能按鈕，在畫板拖動形成綫段。</li>
				<li>扇形：選中一個圓后，點擊“扇形”功能按鈕，在圓上拖動形成扇形。</li>
				<li>圓：點擊“圓”功能按鈕，點擊畫板拖動形成圓。</li>
				<li>半徑：選中一個圓后，在圓上點擊形成半徑。</li>
				<li>直徑：選中一個圓后，在圓上點擊形成直徑。</li>
				<li>文本框：在繪製圖形后，輸入角度/厘米改變圖形大小。</li>
				<li>保存：點擊“保存”功能按鈕，畫板内容保存至本地。</li>
			</ul>
			<button id="interface_close">跳过</button>
		</div>

		<div class="box_body" id="box_body">
			<div class="box_body_border">
				<div class="top_tools_panel">
					<div class="top_tools_panel_left">
						<div class="top_tools_panel_left_color">
							<ul>
								<li><button id="colorBlack"></button></li>
								<li><button id="colorRed"></button></li>
								<li><button id="colorBlue"></button></li>
								<li><button id="colorGreen"></button></li>
								<li><button id="colorYellow"></button></li>
								<li><button id="colorPurple"></button></li>
							</ul>
						</div>

						<div class="top_tools_panel_left_tool">
							<ul>
								<li><button id="rubber" class="nochoosed"></button></li>
								<li><button id="cancle" class="nochoosed"></button></li>
								<li><button id="flag" class="nochoosed"></button></li>
								<li><button id="rule" class="nochoosed"></button></li>
								<li><button id="protractor" class="nochoosed"></button></li>
								<li><button id="rotate" class="nochoosed"></button></li>
							</ul>
						</div>
					</div>
					<div class="top_tools_panel_right"></div>
				</div>

				<div class="center_canvas">
					<canvas id="myCanvas"></canvas>
				</div>


				<div class="right_tools_panel">
					<div class="tools_button">
							<button id="interface_show" style="display:block; cursor:pointer"></button>
						<ul>
							<li><button id="point" class="nochoosed">點</button></li>
			                <li><button id="segment" class="nochoosed">綫段</button></li>
			                <li><button id="circular" class="nochoosed">圓</button></li>
			                <li><button id="fan" class="nochoosed">扇形</button></li>
							<li><button id="radius" class="nochoosed">半徑</button></li>
							<li><button id="diameter" class="nochoosed">直徑</button></li>
			                <li><button id="chord" class="nochoosed">弦</button></li>
			                <!-- <li><button id="tangent" class="nochoosed">切线</button></li> -->
						</ul>
					</div>

					<input type="text" id="value" placeholder="请输入"></input>
					<button class="right_tools_panel_Preservation">保存</button>
				</div>

				<input type="text" id="inputFlag" class="hidden" placeholder="請輸入字母">
			</div>
		</div>
	<script type="text/javascript" src="./js/main.bundle.js"></script></body>
	<script src="./js/mui.min.js"></script>
	<script>
		window.onload = function() {
            var boxHeight = document.body.clientHeight - document.getElementsByClassName('box_head')[0].clientHeight;
			document.getElementsByClassName('box_body')[0].style.height = boxHeight + 'px';

			var width = document.getElementsByClassName('center_canvas')[0].clientWidth;
			var height = document.getElementsByClassName('center_canvas')[0].clientHeight;

			document.getElementById('myCanvas').width = width + '';
            document.getElementById('myCanvas').height = height + '';
            
            // 设置题目内容
            var toolContNode = document.getElementsByClassName('top_tools_panel_left')[0].clientWidth;
            var topToolNode = document.getElementsByClassName('top_tools_panel')[0].clientWidth;
            document.getElementsByClassName('top_tools_panel_right')[0].style.width = (topToolNode - toolContNode - 2) + 'px';
        }
	</script>
	<script src="./js/jquery-3.3.1.min.js"></script>
	<script src="./js/config/config.js"></script>
	<script>
		jQuery(function() {
			(function() {
				// 开启socket
				//stuSocket();

				// 教程的显示与隐藏
				(function() {
					// 教程的显示与隐藏
					jQuery('#interface_show').on('click', function(e) {
						jQuery('#popWindow').css('display', 'block');
						jQuery('#maskLayer').css('display', 'block');
					});
					jQuery('#interface_close').on('click', function(e) {
						jQuery('#popWindow').css('display', 'none');
						jQuery('#maskLayer').css('display', 'none');
					});
				})();

				mui.plusReady(function() {
					// 禁止返回键
					(function() {
						var oldBack = mui.back;
						mui.back = function() {
							return;
						};
					})();

					// 保存按钮
					jQuery('.right_tools_panel_Preservation').on('click', function() {
						var image = new Image();
						imageCont = document.getElementById('myCanvas').toDataURL('image/png');

						var chars = ['0','a','b','1','c','d','2','e','f','3','g','h','4','i','j','5','k','l','6','m','n','7','o','p','8','q','r','9','s','t','u','v','w','x','y','z'];
						var res = "";
						for (var i = 0; i < 10; i++) {
							res += chars[Math.ceil(Math.random()*35)];
						}
						var imgName = new Date().getTime() + res;

						// 先保存到本地，再发送到后端
						var bitmap = new plus.nativeObj.Bitmap('test');
						bitmap.loadBase64Data(imageCont, function() {
							bitmap.save("_doc/" + imgName + ".png", {
								overwrite: true,
								format: 'png',
								quality: 100
							   }, function(i) {
								mui.alert('图片保存成功');
							}, function(e) {
								mui.alert('保存图片失败');
							});
						}, function(e) {
							mui.alert('加载图片失败');
						});
						
						imgUpload({
							imgName: imgName,
							imgData: imageCont
						}, function(data) {
//							if (!data['status']) {
//								return;
//							}
//							var bitmap = new plus.nativeObj.Bitmap('test');
//							bitmap.loadBase64Data(imageCont, function() {
//								bitmap.save("_doc/" + imgName + ".png", {
//									overwrite: true,
//									format: 'png',
//									quality: 100
//								   }, function(i) {
//									mui.alert('图片保存成功');
//								}, function(e) {
//									mui.alert('保存图片失败');
//								});
//							}, function(e) {
//								mui.alert('加载图片失败');
//							});
//							mui.alert('上传图片成功');
						}, function(xml, status, err) {
							mui.alert('请检查网络是否连接');
						});
					});
				});

				// 上传图片
				var imgUpload = function(data, succCall, errCall) {
					jQuery.ajax({
						url: 'http://' + urlConf.host + ':' + urlConf.post + urlConf.root + 'KeepPhoto/base64_image_content',
						type: 'post',
						dataType: 'json',
						timeout: 10000,
						async: true,
						data: data,
						success: function(data) {
							succCall(data);
						},
						error: function(xml, status, err) {
							errCall(xml, status, err);
						}
					});
				};
			})();
		});
	</script>
</html>
